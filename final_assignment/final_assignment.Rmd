---
author: "Study Group 11: Nereid Kwok, Nisa Ozer, Lauren Wade, Thomas Giannetti-Fakhouri, Kazmer Nagy-Betegh, Chandrime Tolia"

title: "Final Assignment"

date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
    df_print: paged
---

```{r , echo=FALSE}


knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)


# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r initialise-libraries, echo=FALSE}

library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(lubridate)
library(labourR)
library(magrittr)
library(gapminder)
library(quantmod)
library(stringr)
library(stringdist)
library(hash)
```



# Data Import

```{r import-ask-manager}

# Google Sheets permissions did not work with my google account

# use googlesheets4 to get data
#url <- "https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792"
#googlesheets4::gs4_auth() # google sheets authorisation

# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
#ask_a_manager_2021 <- googlesheets4::read_sheet(url) %>%
 # janitor::clean_names()

# if googlesheets is now working, read local copy
 ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))%>%
   janitor::clean_names()
  
```

# Intitial Data Exploration and Cleaning

```{r data-explore}

skimr::skim(ask_a_manager_2021)
```


## Clean Country Names

```{r country-code-cleaning}

# unique(ask_a_manager_2021$country) # checking the list of unique country codes reveals that country names are inconsistent across the data

ask_a_manager_2021_cleaned <- ask_a_manager_2021%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021$country, 
                                       origin = 'country.name', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021_cleaned$country, 
                                       origin = 'unicode.symbol', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )



country_list <- unique(countryname_dict$country.name.en)

typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
  
unique(typos$country) #identifying the the typos and mismatches that the country code library couldn't deal with

typo_map <- hash() #create a map for the correct version of the typos


typo_map[["United Kingdom"]] <- list("Scotland",
                                     "England",
                                     "Northern Ireland",
                                     "England/UK",
                                     "England, UK",
                                     "United Kindom",
                                     "UK (Northern Ireland)",                                                                                              "UK for U.S. company",
                                     "England, Gb",
                                     "Englang",
                                     "England, Gb",
                                     "U.K. (northern England)",
                                     "Unites kingdo",
                                     "Unites kingdom",
                                     "UK (England)",
                                     "england",
                                     "Jersey", 
                                     "Channel islands",
                                     "UK, remote",
                                     "Scotland, UK",
                                     "England, UK.",
                                     "Jersey, Channel islands",
                                     "Wales, UK",
                                     "Wales (UK)",
                                     "UK, but for globally fully remote company",
                                     "Wales"
                                     )
typo_map[["United States"]] <- list("United State",
  "ISA",
 "America",
"United State of America",
"United Stated",
"USA-- Virgin Islands",
"United Statws" ,
"Unites States" ,
"U. S.",
"United Sates",
"Uniited States",
"Worldwide (based in US but short term trips aroudn the world)",
"United Sates of America",
"United States (I work from home and my clients are all over the US/Canada/PR",
"Unted States",
"United Statesp",
"United Stattes",
"United Statea",
"United Statees",
"Uniyed states",
"Uniyes States",
"United Status",
"Uniteed States",
"United Stares",
"Unites states",
"Unite States",
"The US",
"United statew",
"United Statues",
"Untied States",
"Unitied States",
"United Sttes",
"united stated",
"Uniter Statez",
"U. S" ,
"United Stateds",
"Usat",
"Unitef Stated",
"USaa",
"america",
"United States- Puerto Rico",
"California",
"Virginia",
"Hartford",
"San Francisco",
"USD",
"United Statss",
"I work for a UAE-based organization, though I am personally in the US.",
"United  States",
"U.A.",
"UXZ",
"USS",
"IS",
"USAB",
"UA",
"I.S",
"I.S.",
"United y"
)

typo_map[["Canada"]] <- list(
  "Canadw",
"Can",
"Canda",
"Canada and USA",
"Csnada",
"Canad"
)

typo_map[["NA"]] <- list(
  "Contracts",
"We don't get raises, we get quarterly bonuses, but they periodically asses income in the area you work, so I got a raise because a 3rd party assessment showed I was paid too little for the area we were located",
"Global" ,
"Currently finance",
"UXZ",
"$2,175.84/year is deducted for benefits",
"Remote",
"bonus based on meeting yearly goals set w/ my supervisor",
"I earn commission on sales. If I meet quota, I'm guaranteed another 16k min. Last year i earned an additional 27k. It's not uncommon for people in my space to earn 100k+ after commission.",
"I was brought in on this salary to help with the EHR and very quickly was promoted to current position but compensation was not altered.",
"n/a (remote from wherever I want)",
"Africa",
"europe",
"na",
"Policy",
"NA",
"International",
"NZ",
"Y"
)

typo_map[["Spain"]] <- list("Catalonia")

typo_map[["Australia"]] <- list("Australi")

typo_map[["Denmark"]] <- list("Danmark")

typo_map[["Netherlands"]] <- list("NL",
"Nederland")

typo_map[["Panama"]] <- list("Panamá")

typo_map[["Brazil"]] <- list("Brasil")

typo_map[["Argentina"]] <- list("ARGENTINA BUT MY ORG IS IN THAILAND")

typo_map[["Mexico"]] <- list("México")

for (c in keys(typo_map))
{
  ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country = case_when(country %in% values(typo_map, keys = c) ~c,
                              !country %in% values(typo_map, keys = c) ~ country))
}

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country_code = countrycode::countrycode(sourcevar =  ask_a_manager_2021_cleaned$country,
                                                 origin = 'country.name',
                                                 destination = 'iso3c',
                                                 nomatch = NA,
                                                 warn = TRUE))

```


```{r}
typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
unique(typos$country)

unique(ask_a_manager_2021_cleaned$country)
```

## Currency 

```{r }

ask_a_manager_2021_cleaned$currency <- substr(ask_a_manager_2021_cleaned$currency, 0, 3)

from <- ask_a_manager_2021_cleaned$currency
to <- c("USD")
exchange_rate <- getQuote(paste0(from, to, "=X"))
  
exchange_rate <- exchange_rate[-c(8),] 

exchange_rate <- exchange_rate %>% 
  mutate(currency = c("USD", "GBP", "CAD", "EUR", "AUD", "CHF", "ZAR", "SEK", "HKD", "JPY")) %>% 
  select(currency, Last)%>%
  clean_names()

ask_a_manager_2021_cleaned <-
  merge(ask_a_manager_2021_cleaned, exchange_rate, by="currency", all.x = T)

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned %>%  
  mutate(salary_USD = annual_salary * last)%>%
  clean_names()

```


1.) Mean salary for US, UK, Canada, Australia, Germany,
```{r}
library(infer)
#we want to work on the top 5 countries with the most data points..

country_codes <- c("USA", "GBR", "AUS", "CAN", "DEU")

mean_salary_by_country <- ask_a_manager_2021_cleaned %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(country_code  %in% country_codes ) %>% 
  group_by(country_code) %>% 
  summarise(mean_salary = mean(salary_usd)) %>% 
  arrange(desc(mean_salary))
  

mean_salary_by_country
set.seed(123)

#####CI for USA Salary

#confidence interval bootstrap
boot_dist_usa <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "USA") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")
boot_dist_usa

#CI and mean table
percentile_ci_usa <- get_ci(boot_dist_usa , level = 0.95, type ="percentile") %>% 
  mutate(country_code = " USA",
         mean = mean(boot_dist_usa$stat)) %>% 
  relocate(country_code)

percentile_ci_usa


#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_usa ) +
  shade_ci(endpoints = percentile_ci1, fill="khaki")

#####CI for Germany Salary

#confidence interval bootstrap
boot_dist_deu <-ask_a_manager_2021_cleaned%>% 
  filter(country_code == "DEU") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")

boot_dist_deu

#Creating the CI table with the country code
percentile_ci_deu <- get_ci(boot_dist_deu , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "DEU",
         mean = mean(boot_dist_deu$stat)) %>% 
  relocate(country_code)
percentile_ci_deu


#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_deu) +
  shade_ci(endpoints = percentile_ci2, fill="khaki")



######CI for Australia Salary

#confidence interval bootstrap
boot_dist_aus <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "AUS") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")


#creating the CI table with country code
percentile_ci_aus <- get_ci(boot_dist_aus , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "AUS",
         mean = mean(boot_dist_aus$stat)) %>% 
  relocate(country_code) 

percentile_ci_aus

#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_aus) +
  shade_ci(endpoints = percentile_ci2, fill="khaki")



####CI for UK
  
  boot_dist_gbr <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "GBR") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")
  
  
#creating the CI table with country code
percentile_ci_gbr <- get_ci(boot_dist_gbr , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "GBR",
         mean = mean(boot_dist_gbr$stat)) %>% 
  relocate(country_code)

 percentile_ci_gbr 

#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_gbr) +
  shade_ci(endpoints = percentile_ci4, fill="khaki")

#####CI for Canada Salary
  
  #confidence interval bootstrap
boot_dist_can <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "CAN") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")


#creating the CI table with country code
percentile_ci_can <- get_ci(boot_dist_can , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "CAN",
         mean = mean(boot_dist_can$stat)) %>% 
  relocate(country_code)

percentile_ci_can 
#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_can) +
  shade_ci(endpoints = percentile_ci5, fill="khaki")
  
  
#Merged table of CIs and means..
merged_table <- rbind(percentile_ci_usa, percentile_ci_deu) 
merged_table <- rbind(merged_table, percentile_ci_aus) 
merged_table <- rbind(merged_table, percentile_ci_gbr) 
merged_table <- rbind(merged_table, percentile_ci_can)
merged_table



#Graph of CIs:


 
table(ask_a_manager_2021_cleaned$country)

```

CI graphs for the mean salary by country:

```{r}


mean_salary_comparison %>% 
  ggplot(aes)
```


```{r}



median_salary_by_country <- ask_a_manager_2021_cleaned %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(country_code  %in% country_codes ) %>% 
  group_by(country_code) %>% 
  summarise(median_salary = median(salary_usd)) %>% 
  arrange(desc(median_salary))


median_salary_by_country

#hypothesis salary between deu and usa 

#confidence bootstrap

```


2.) Top 5 Sectors such as Tech salary for US, Uk bla bla...


3.) regression: country ~ salary...
+
country, education 
+
country, education, experience






