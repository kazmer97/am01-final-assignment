---
author: "Study Group 11: Nereid Kwok, Nisa Ozer, Lauren Wade, Thomas Giannetti-Fakhouri, Kazmer Nagy-Betegh, Chandrime Tolia"

title: "Final Assignment"

date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
    df_print: paged
---

```{r , echo=FALSE}


knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)


# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r initialise-libraries, echo=FALSE}

library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(lubridate)
library(labourR)
library(magrittr)
library(gapminder)
library(quantmod)
library(stringr)
library(stringdist)
library(hash)
library(scales)
library(gt)
```



# Data Import

```{r import-ask-manager}

# Google Sheets permissions did not work with my google account

# use googlesheets4 to get data
url <- "https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792"
googlesheets4::gs4_auth() # google sheets authorisation

# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- googlesheets4::read_sheet(url) %>%
  janitor::clean_names()

# if googlesheets is now working, read local copy
# ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))%>%
  # janitor::clean_names()
  
```

# Intitial Data Exploration and Cleaning

```{r data-explore}

skimr::skim(ask_a_manager_2021)
```


## Clean Country Names

```{r country-code-cleaning}

# unique(ask_a_manager_2021$country) # checking the list of unique country codes reveals that country names are inconsistent across the data

ask_a_manager_2021_cleaned <- ask_a_manager_2021%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021$country, 
                                       origin = 'country.name', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021_cleaned$country, 
                                       origin = 'unicode.symbol', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )



country_list <- unique(countryname_dict$country.name.en)

typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
  
unique(typos$country) #identifying the the typos and mismatches that the country code library couldn't deal with

typo_map <- hash() #create a map for the correct version of the typos


typo_map[["United Kingdom"]] <- list("Scotland",
                                     "England",
                                     "Northern Ireland",
                                     "England/UK",
                                     "England, UK",
                                     "United Kindom",
                                     "UK (Northern Ireland)",                                                                                              "UK for U.S. company",
                                     "England, Gb",
                                     "Englang",
                                     "England, Gb",
                                     "U.K. (northern England)",
                                     "Unites kingdo",
                                     "Unites kingdom",
                                     "UK (England)",
                                     "england",
                                     "Jersey", 
                                     "Channel islands",
                                     "UK, remote",
                                     "Scotland, UK",
                                     "England, UK.",
                                     "Jersey, Channel islands",
                                     "Wales, UK",
                                     "Wales (UK)",
                                     "UK, but for globally fully remote company",
                                     "Wales"
                                     )
typo_map[["United States"]] <- list("United State",
  "ISA",
 "America",
"United State of America",
"United Stated",
"USA-- Virgin Islands",
"United Statws" ,
"Unites States" ,
"U. S.",
"United Sates",
"Uniited States",
"Worldwide (based in US but short term trips aroudn the world)",
"United Sates of America",
"United States (I work from home and my clients are all over the US/Canada/PR",
"Unted States",
"United Statesp",
"United Stattes",
"United Statea",
"United Statees",
"Uniyed states",
"Uniyes States",
"United Status",
"Uniteed States",
"United Stares",
"Unites states",
"Unite States",
"The US",
"United statew",
"United Statues",
"Untied States",
"Unitied States",
"United Sttes",
"united stated",
"Uniter Statez",
"U. S" ,
"United Stateds",
"Usat",
"Unitef Stated",
"USaa",
"america",
"United States- Puerto Rico",
"California",
"Virginia",
"Hartford",
"San Francisco",
"USD",
"United Statss",
"I work for a UAE-based organization, though I am personally in the US.",
"United  States",
"U.A.",
"UXZ",
"USS",
"IS",
"USAB",
"UA",
"I.S",
"I.S.",
"United y"
)

typo_map[["Canada"]] <- list(
  "Canadw",
"Can",
"Canda",
"Canada and USA",
"Csnada",
"Canad"
)

typo_map[["NA"]] <- list(
  "Contracts",
"We don't get raises, we get quarterly bonuses, but they periodically asses income in the area you work, so I got a raise because a 3rd party assessment showed I was paid too little for the area we were located",
"Global" ,
"Currently finance",
"UXZ",
"$2,175.84/year is deducted for benefits",
"Remote",
"bonus based on meeting yearly goals set w/ my supervisor",
"I earn commission on sales. If I meet quota, I'm guaranteed another 16k min. Last year i earned an additional 27k. It's not uncommon for people in my space to earn 100k+ after commission.",
"I was brought in on this salary to help with the EHR and very quickly was promoted to current position but compensation was not altered.",
"n/a (remote from wherever I want)",
"Africa",
"europe",
"na",
"Policy",
"NA",
"International",
"NZ",
"Y"
)

typo_map[["Spain"]] <- list("Catalonia")

typo_map[["Australia"]] <- list("Australi")

typo_map[["Denmark"]] <- list("Danmark")

typo_map[["Netherlands"]] <- list("NL",
"Nederland")

typo_map[["Panama"]] <- list("Panamá")

typo_map[["Brazil"]] <- list("Brasil")

typo_map[["Argentina"]] <- list("ARGENTINA BUT MY ORG IS IN THAILAND")

typo_map[["Mexico"]] <- list("México")

for (c in keys(typo_map))
{
  ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country = case_when(country %in% values(typo_map, keys = c) ~c,
                              !country %in% values(typo_map, keys = c) ~ country))
}

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country_code = countrycode::countrycode(sourcevar =  ask_a_manager_2021_cleaned$country,
                                                 origin = 'country.name',
                                                 destination = 'iso3c',
                                                 nomatch = NA,
                                                 warn = TRUE))

```


```{r}
typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
unique(typos$country)

unique(ask_a_manager_2021_cleaned$country)
```

## Currency 

```{r }

ask_a_manager_2021_cleaned$currency <- substr(ask_a_manager_2021_cleaned$currency, 0, 3)

from <- ask_a_manager_2021_cleaned$currency
to <- c("USD")
exchange_rate <- getQuote(paste0(from, to, "=X"))
  
exchange_rate <- exchange_rate[-c(8),] 

exchange_rate <- exchange_rate %>% 
  mutate(currency = c("USD", "GBP", "CAD", "EUR", "AUD", "CHF", "ZAR", "SEK", "HKD", "JPY")) %>% 
  select(currency, Last)%>%
  clean_names()

ask_a_manager_2021_cleaned <-
  merge(ask_a_manager_2021_cleaned, exchange_rate, by="currency", all.x = T)

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned %>%  
  mutate(salary_USD = annual_salary * Last)%>%
  clean_names()

```

# Analyses by Race 

## Multiple Races

By looking at the data it can be seen the quite a few respondents have filled out multiple options. Let s visualise how many exactly.

### Number of responses with each number of Races

```{r race-multiple-resp}


n_race_responses <- ask_a_manager_2021_cleaned%>%
  mutate(race = str_split(race,pattern = ","))%>%
  rowwise()%>%
  mutate(n_race = length(race))

n_race_sumary <- n_race_responses%>%
  group_by(n_race)%>%
  summarise(n = n())%>%
  mutate(prct = n/sum(n))

n_race_responses <- left_join(n_race_responses, n_race_sumary, by = "n_race")


ggplot(n_race_responses, 
       aes(n_race))+
  geom_bar(alpha = 0.8)+
  scale_y_log10()+
  theme_bw()+
  labs(title = "Number of Races survey respondents Identified with",
       x = "Number of Races",
       y = "Count (y axis scaled to log10)")+
  scale_x_continuous(breaks = pretty_breaks(6))+
  geom_text(aes(label = formatC(..count.., format = "f", big.mark = ",", digits = 0)), 
            stat = "count",  
            vjust = -0.4)

```

```{r}

n_race_sumary <- n_race_sumary %>%
  mutate(prct = round(prct*100, 2),
         n = formatC(n, format = "f", big.mark = ",", digits = 0))
colnames(n_race_sumary) <- c("Number of Races Respondant Identifies with",
             "Number of Respondants",
            "% of Of total respodants")
n_race_sumary
    
```
### Multiple Race by Gender and Age

Distribution of men and women who identify as more than one Race

```{r race-gender-age}

m_race_gender_summary <- n_race_responses%>%
  mutate(gender = factor(gender,
         levels = c("Man","Woman","Non-binary","Other or prefer not to answer", "NA")))%>%
  filter(n_race > 1, !is.na(gender))%>%
  group_by(gender, n_race, how_old_are_you)%>%
  summarise(number = n())%>%
  mutate(prct = number/sum(number))

ggplot(m_race_gender_summary, aes(y = number, x = reorder(n_race, number)))+
  geom_col()+
  facet_grid(gender~how_old_are_you)+
  coord_flip()+
  theme_bw()+
  labs(
    title = "Number of Race's a person identifies with by Age and Gender",
    y = "Number of Race options ticked by Respondant",
    x = "Number of Respondants"
  )

```

If we analyse the respondents that selected more then 1 race that they identify with we can see from the graph that the most prominent age groups are 25-34 and and 35-44 which would mean that Millenials are the most likely identify with multiple race's. And within the Millennial group it seems like women are more likely to do that then men. This shall be evaluated by a hypothesis testing. 

H0 = Millennial women are  equally likely to identify with multiple races as millennial men.
H1 = Millennial women are not equally likely to identify with multiple races as millennial men.

```{r millenial-race-test}

n_race_responses <- n_race_responses%>%
  mutate(multiple_race = case_when(n_race > 1 ~ 1,
                                   n_race == 1 ~0))

mill_men <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44") & n_race_responses$gender == "Man",
                   select = c(multiple_race))

mill_men

mill_women <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44") & n_race_responses$gender == "Woman",
                   select = c(multiple_race))

mill_women

t.test(mill_men, mill_women)

```

H0 cannot be rejected as the t-value is less then 2. Which means the difference seen in tendency to identify with multiple races between genders is due to the unequal sample sizes.

Now lets test for the chance whether the being a millennial truly increases the likelihood of identifying with multiple races.

H0 = The proportion of millennials identifying with multiple races is the same as the proportion of other age groups that identify with multiple races. 

H1 = The proportion of millennials identifying with multiple races is not the same as the proportion of other age groups that identify with multiple races. 
```{r multiple-race-age}

millennial <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44"),
                   select = c(multiple_race))

non_millenial <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you != "25-34" & n_race_responses$how_old_are_you != "35-44"),
                   select = c(multiple_race))

t.test(millennial, non_millenial)



```
The H0 hypothesis can be rejected as t value is above 2. Which means that it can be said with 95% confidence that there is a difference between the proportion of millennials that identify with multiple races and all other age groups. 


### Multiple Race by Country

```{r multiple-race-country}
m_race_country_summary <- n_race_responses%>%
  mutate(gender = factor(gender,
         levels = c("Man","Woman","Non-binary","Other or prefer not to answer", "NA")))%>%
  filter(!is.na(country))%>%
  group_by(country)%>%
  summarise(multiple_race, pop = n())%>%
  ungroup()%>%
  group_by(country, multiple_race)%>%
  summarise(pop, 
            mult_race_num = n())%>%
  filter(multiple_race ==1)%>%
  mutate(prop_resp  = multiple_race/pop)%>% # get the percentage of respondants that identify with multiple races
  group_by(country)%>%
  summarise(pop = max(pop),
            mult_race_num = max(mult_race_num), 
            prop_resp = round(max(prop_resp)*100, 5))%>%
  arrange(desc(prop_resp))

colnames(m_race_country_summary) <- c("Country","Num. Responses", "Num. Responses with Num. Race >1","% of response with num_race > 1")

m_race_country_summary
```


Some Countries have a very small representation within the dataset and the respondents from there have filled out multiple races. These countries will be excluded from the race statistics going forward where only entries with a single race will be used as the multi race selections are a relatively low proportion of the respondents. 


## Single Race Responses


```{r single-race}
single_race_data <- n_race_responses%>%
  filter(multiple_race == 0) # only use responses that only put down one race


# remove countries with less then 10 respondants

single_race_data <-single_race_data%>%
  group_by(country)%>%
  mutate(num_resp = n())%>%
  ungroup()

```

### Race distribution from countries with more then 50 responses

```{r race-distribution}

country_race <- single_race_data%>%
  filter(num_resp > 50, !is.na(race))%>%
  rowwise()%>%
  mutate(race = as.character(race[1]))%>%
  group_by(country, race)%>%
  summarise(num_resp, race_count = n())%>%
  mutate(race_prc = race_count/num_resp)%>%
  summarise(num_resp = max(num_resp),
            race_count = max(race_count),
            race_prc = max(race_prc))%>%
  mutate(race_prc = round(race_prc*100,2))

ggplot(country_race,aes(x = reorder(race, -race_prc), y = race_prc))+
  geom_col( aes(fill = race))+
  facet_wrap(~country)+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank())+
  labs(title = "Population Distribution in Countries with more then 50 respondants",
       y = "% of Respondants",
       fill  = "Race Classification")
```
### Race by Industry

```{r}



```

