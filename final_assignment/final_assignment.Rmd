---
author: "Study Group 11: Nereid Kwok, Nisa Ozer, Lauren Wade, Thomas Giannetti-Fakhouri, Kazmer Nagy-Betegh, Chandrime Tolia"

title: "Final Assignment"

date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
    df_print: paged
---

```{r , echo=FALSE}


knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)


# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

# Package Loading

```{r initialise-libraries, echo=FALSE}

library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(lubridate)
library(labourR)
library(magrittr)
library(gapminder)
library(quantmod)
library(stringr)
library(stringdist)
library(hash)
library(scales)
library(gt)
library(labourR)
library(here)
install.packages("moderndive")
library(moderndive)
library(tidyverse)
library(infer)
library(mosaic)
install.packages("huxtable")
library(huxtable)
install.packages("kableExtra")
library(kableExtra)
library(skimr)
library(ggfortify)
library(car)
```

# Data Import

```{r import-ask-manager}

# Google Sheets permissions did not work with my google account

# use googlesheets4 to get data
#url <- "https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792"
#googlesheets4::gs4_auth() # google sheets authorisation

# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/

#ask_a_manager_2021 <- googlesheets4::read_sheet(url) %>%
 # janitor::clean_names()

# if googlesheets is now working, read local copy
 ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))%>%
   janitor::clean_names()
   
```

# Intitial Data Exploration and Cleaning

```{r data-explore}

skimr::skim(ask_a_manager_2021)
```

## Clean Country Names

```{r country-code-cleaning}

# unique(ask_a_manager_2021$country) # checking the list of unique country codes reveals that country names are inconsistent across the data

ask_a_manager_2021_cleaned <- ask_a_manager_2021%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021$country, 
                                       origin = 'country.name', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021_cleaned$country, 
                                       origin = 'unicode.symbol', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )



country_list <- unique(countryname_dict$country.name.en)

typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
  
unique(typos$country) #identifying the the typos and mismatches that the country code library couldn't deal with

typo_map <- hash() #create a map for the correct version of the typos


typo_map[["United Kingdom"]] <- list("Scotland",
                                     "England",
                                     "Northern Ireland",
                                     "England/UK",
                                     "England, UK",
                                     "United Kindom",
                                     "UK (Northern Ireland)",                                                                                              "UK for U.S. company",
                                     "England, Gb",
                                     "Englang",
                                     "England, Gb",
                                     "U.K. (northern England)",
                                     "Unites kingdo",
                                     "Unites kingdom",
                                     "UK (England)",
                                     "england",
                                     "Jersey", 
                                     "Channel islands",
                                     "UK, remote",
                                     "Scotland, UK",
                                     "England, UK.",
                                     "Jersey, Channel islands",
                                     "Wales, UK",
                                     "Wales (UK)",
                                     "UK, but for globally fully remote company",
                                     "Wales"
                                     )
typo_map[["United States"]] <- list("United State",
  "ISA",
 "America",
"United State of America",
"United Stated",
"USA-- Virgin Islands",
"United Statws" ,
"Unites States" ,
"U. S.",
"United Sates",
"Uniited States",
"Worldwide (based in US but short term trips aroudn the world)",
"United Sates of America",
"United States (I work from home and my clients are all over the US/Canada/PR",
"Unted States",
"United Statesp",
"United Stattes",
"United Statea",
"United Statees",
"Uniyed states",
"Uniyes States",
"United Status",
"Uniteed States",
"United Stares",
"Unites states",
"Unite States",
"The US",
"United statew",
"United Statues",
"Untied States",
"Unitied States",
"United Sttes",
"united stated",
"Uniter Statez",
"U. S" ,
"United Stateds",
"Usat",
"Unitef Stated",
"USaa",
"america",
"United States- Puerto Rico",
"California",
"Virginia",
"Hartford",
"San Francisco",
"USD",
"United Statss",
"I work for a UAE-based organization, though I am personally in the US.",
"United  States",
"U.A.",
"UXZ",
"USS",
"IS",
"USAB",
"UA",
"I.S",
"I.S.",
"United y"
)

typo_map[["Canada"]] <- list(
  "Canadw",
"Can",
"Canda",
"Canada and USA",
"Csnada",
"Canad"
)

typo_map[["NA"]] <- list(
  "Contracts",
"We don't get raises, we get quarterly bonuses, but they periodically asses income in the area you work, so I got a raise because a 3rd party assessment showed I was paid too little for the area we were located",
"Global" ,
"Currently finance",
"UXZ",
"$2,175.84/year is deducted for benefits",
"Remote",
"bonus based on meeting yearly goals set w/ my supervisor",
"I earn commission on sales. If I meet quota, I'm guaranteed another 16k min. Last year i earned an additional 27k. It's not uncommon for people in my space to earn 100k+ after commission.",
"I was brought in on this salary to help with the EHR and very quickly was promoted to current position but compensation was not altered.",
"n/a (remote from wherever I want)",
"Africa",
"europe",
"na",
"Policy",
"NA",
"International",
"NZ",
"Y"
)

typo_map[["Spain"]] <- list("Catalonia")

typo_map[["Australia"]] <- list("Australi")

typo_map[["Denmark"]] <- list("Danmark")

typo_map[["Netherlands"]] <- list("NL",
"Nederland")

typo_map[["Panama"]] <- list("Panamá")

typo_map[["Brazil"]] <- list("Brasil")

typo_map[["Argentina"]] <- list("ARGENTINA BUT MY ORG IS IN THAILAND")

typo_map[["Mexico"]] <- list("México")

for (c in keys(typo_map))
{
  ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country = case_when(country %in% values(typo_map, keys = c) ~c,
                              !country %in% values(typo_map, keys = c) ~ country))
}

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country_code = countrycode::countrycode(sourcevar =  ask_a_manager_2021_cleaned$country,
                                                 origin = 'country.name',
                                                 destination = 'iso3c',
                                                 nomatch = NA,
                                                 warn = TRUE))

```

```{r}
typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
unique(typos$country)

unique(ask_a_manager_2021_cleaned$country)
```

## Clean Currency and Salary data

```{r }

ask_a_manager_2021_cleaned$currency <- substr(ask_a_manager_2021_cleaned$currency, 0, 3)

annual_salary_stats <- mosaic::favstats(ask_a_manager_2021_cleaned$annual_salary)

# check if the selected currency matches the provided country
ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(match_currency = countrycode(country, "country.name", "iso4217c"),
       check_match = match_currency==currency)

# change the currency for the highest annual salaries if they don't match the countries currency as it is likely wrong
ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(currency = case_when(annual_salary > annual_salary_stats$Q3 & check_match == F ~ match_currency,
                              TRUE ~ currency))

from <- unique(ask_a_manager_2021_cleaned$match_currency)
to <- c("USD")
exchange_rate <- getQuote(paste0(from, to, "=X"))

exchange_rate <- exchange_rate%>%
  tibble::rownames_to_column(var = "index")

exchange_rate <- exchange_rate %>% 
  mutate(currency = substring(exchange_rate$index, first = 1, last =3)) %>% 
  select(index, currency, Last)%>%
  clean_names()

ask_a_manager_2021_cleaned <-
  merge(ask_a_manager_2021_cleaned, exchange_rate, by="currency", all.x = T)
  

ask_a_manager_2021_cleaned <- rename(ask_a_manager_2021_cleaned, exrate_to_USD = last)

ask_a_manager_2021_cleaned <- rename(ask_a_manager_2021_cleaned, exchange_matching_check = index)

#calculate usd salary
ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned %>%  
  mutate(salary_usd = annual_salary * exrate_to_USD)%>%
  clean_names()


usd_salary_stats <- mosaic::favstats(ask_a_manager_2021_cleaned$salary_usd)

```

**Check some of the lowest values within the dataset some of them likely left of 1000**
```{r}

potential_000missing <- ask_a_manager_2021_cleaned%>%
  filter(salary_usd <= 999)

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(annual_salary = case_when(salary_usd < 1000 ~ annual_salary*1000,
                                   TRUE ~ annual_salary),
         salary_usd = case_when(salary_usd < 1000 ~ salary_usd*1000,
                                   TRUE ~ salary_usd))

usd_salary_stats <- mosaic::favstats(ask_a_manager_2021_cleaned$salary_usd)


```


## Industry {.tabset}


```{r industry-cleaning}
standard_industry <- c("Accounting, Banking & Finance",
                       "Agriculture or Forestry",
                       "Art & Design",
                       "Business or Consulting",
                       "Computing or Tech",
                       "Education (Primary/Secondary)",
                       "Education (Higher Education)",
                       "Engineering or Manufacturing",
                       "Entertainment",
                       "Government and Public Administration",
                       "Health care",
                       "Hospitality & Events",
                       "Insurance",
                       "Law",
                       "Law Enforcement & Security",
                       "Leisure, Sport & Tourism",
                       "Marketing, Advertising & PR",
                       "Media & Digital",
                       "Nonprofits",
                       "Property or Construction",
                       "Recruitment or HR",
                       "Retail",
                       "Sales",
                       "Social Work",
                       "Transport or Logistics",
                       "Utilities & Telecommunications")

non_standard_industry <- c("Mining and Mentals",
                           "Aerospace & Defence",
                           "Automotive",
                           "Biotechnology",
                           "Church",
                           "Food & Bevarage",
                           "Animal Care",
                           "Library & Publishing",
                           "Fashion")


industry_map <- hash()

for(i in standard_industry)
{
  industry_map[[as.character(i)]] <- c("")
}

for(i in non_standard_industry)
{
  industry_map[[as.character(i)]] <- c("")
}

 
ask_a_manager_2021_cleaned%>%
  filter(industry %in% standard_industry)
# roughly 2000 people used the other function within the industry section.....
```

```{r }
# identify all instances put down to the other category
outliers_table <- ask_a_manager_2021_cleaned%>%
  select(industry)%>%
  filter(!industry %in% standard_industry)%>%
  mutate(industry = tolower(industry))

#make a list out of it
outliers <-  tolower(unique(ask_a_manager_2021_cleaned$industry[!ask_a_manager_2021_cleaned$industry %in% standard_industry]))

science_related <- outliers[grep("science",outliers)]
```

### Higher education

```{r industry-cleaning-1}
# Higher education
industry_map[["Education (Higher Education)"]] <- outliers[grep("academ",outliers)]


industry_map[["Education (Higher Education)"]] <- industry_map[["Education (Higher Education)"]][-grep("non-aca",industry_map[["Education (Higher Education)"]])]

industry_map[["Education (Higher Education)"]]<- industry_map[["Education (Higher Education)"]][-grep("not",industry_map[["Education (Higher Education)"]])]

industry_map[["Education (Higher Education)"]]<- c(outliers[grep("higher educ",outliers)],
                                                   industry_map[["Education (Higher Education)"]])

industry_map[["Education (Higher Education)"]]<- c(outliers[grep("university",outliers)],
                                                   industry_map[["Education (Higher Education)"]])

industry_map[["Education (Higher Education)"]]<- c(outliers[grep("college",outliers)],
                                                   industry_map[["Education (Higher Education)"]])
outliers_classified <- industry_map[["Education (Higher Education)"]]
```

### Sales

```{r industry-cleaning-2}
industry_map[["Sales"]] <- c(outliers[grep("procurement",outliers)],
                                       industry_map[["Sales"]])


outliers_classified <-c(industry_map[["Sales"]],
                        outliers_classified)
```

### Banking and Finance

```{r industry-cleaning-3}
industry_map[["Accounting, Banking & Finance"]] <-  c(outliers[grep("acturial",outliers)],
                                       industry_map[["Accounting, Banking & Finance"]])

industry_map[["Accounting, Banking & Finance"]] <-  c(outliers[grep("finance",outliers)],
                                       industry_map[["Accounting, Banking & Finance"]])

industry_map[["Accounting, Banking & Finance"]] <-  c(outliers[grep("private equity",outliers)],
                                       industry_map[["Accounting, Banking & Finance"]])


outliers_classified <-c(industry_map[["Accounting, Banking & Finance"]],
                        outliers_classified)
```

### Engineering Manufacturing

```{r industry-cleaning-4}

industry_map[["Engineering or Manufacturing"]] <-c()

industry_map[["Engineering or Manufacturing"]] <- c(outliers[grep("^(?=.*manufactur)(?!.*food)(?!.*aerospace)",outliers, perl = TRUE)],
                                       industry_map[["Engineering or Manufacturing"]])

industry_map[["Engineering or Manufacturing"]] <- c(outliers[grep("mining",outliers, perl = TRUE)],
                                       industry_map[["Engineering or Manufacturing"]])

industry_map[["Engineering or Manufacturing"]] <- c(outliers[grep("oil",outliers, perl = TRUE)],
                                       industry_map[["Engineering or Manufacturing"]])

industry_map[["Engineering or Manufacturing"]]

outliers_classified <-c(industry_map[["Engineering or Manufacturing"]],
                        outliers_classified)
```

### Health Care

```{r industry-cleaning-5}
industry_map[["Health care"]] <-c()

industry_map[["Health care"]] <- c(outliers[grep("^(?=.*medical)(?!.*not)",outliers, perl = TRUE)],
                                   industry_map[["Health care"]])

industry_map[["Health care"]] <- c(outliers[grep("pharmaceuticals",outliers)],
                                   industry_map[["Health care"]])

industry_map[["Health care"]] <- c(outliers[grep("beauty",outliers)],
                                   industry_map[["Health care"]])

industry_map[["Health care"]] <- c(outliers[grep("bio",outliers)],
                                   industry_map[["Health care"]])

industry_map[["Health care"]] <- c(outliers[grep("pharma",outliers)],
                                   industry_map[["Health care"]])

industry_map[["Health care"]] <- c(outliers[grep("health",outliers)],
                                   industry_map[["Health care"]])

outliers_classified <-c(industry_map[["Health care"]],
                        outliers_classified)

industry_map[["Health care"]]
```

### Tech

```{r industry-cleaning-6}
industry_map[["Computing or Tech"]] <- c(outliers[grep("^tech$",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("^technology",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("software",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("internet",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("video game",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("virtual real",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("ed-tech",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("edtech",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("e-commerce",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("ecommerce",outliers)],
                                   industry_map[["Computing or Tech"]])

industry_map[["Computing or Tech"]] <- c(outliers[grep("technology",outliers)],
                                   industry_map[["Computing or Tech"]])



outliers_classified <-c(industry_map[["Computing or Tech"]],
                        outliers_classified)
```

### Transport or Logistics

```{r industry-cleaning-7}
industry_map[["Transport or Logistics"]] <- c(outliers[grep("distribution",outliers)],
                                   industry_map[["Transport or Logistics"]])

industry_map[["Transport or Logistics"]] <- c(outliers[grep("import",outliers)],
                                   industry_map[["Transport or Logistics"]])

industry_map[["Transport or Logistics"]] <- c(outliers[grep("supply chain",outliers)],
                                   industry_map[["Transport or Logistics"]])

industry_map[["Transport or Logistics"]] <- c(outliers[grep("wholesale",outliers)],
                                   industry_map[["Transport or Logistics"]])

industry_map[["Transport or Logistics"]] <- c(outliers[grep("warehous",outliers)],
                                   industry_map[["Transport or Logistics"]])

outliers_classified <-c(industry_map[["Transport or Logistics"]],
                        outliers_classified)
```

### Government and Public Administration

```{r industry-cleaning-8}
industry_map[["Government and Public Administration"]] <- c(outliers[grep("government",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("politic",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("administration",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("public health",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("urban planning",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("union",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("cultur",outliers)],
                                   industry_map[["Government and Public Administration"]])

industry_map[["Government and Public Administration"]] <- c(outliers[grep("park",outliers)],
                                   industry_map[["Government and Public Administration"]])

outliers_classified <-c(industry_map[["Government and Public Administration"]],
                        outliers_classified)
```

### Property or Construction

```{r industry-cleaning-9}
industry_map[["Property or Construction"]] <- c(outliers[grep("architect",outliers)],
                                   industry_map[["Property or Construction"]])

industry_map[["Property or Construction"]] <- c(outliers[grep("construct",outliers)],
                                   industry_map[["Property or Construction"]])

industry_map[["Property or Construction"]] <- c(outliers[grep("real estate",outliers)],
                                   industry_map[["Property or Construction"]])

industry_map[["Property or Construction"]] <- c(outliers[grep("interior",outliers)],
                                   industry_map[["Property or Construction"]])

industry_map[["Property or Construction"]] <- c(outliers[grep("exterior",outliers)],
                                   industry_map[["Property or Construction"]])

outliers_classified <-c(industry_map[["Property or Construction"]],
                        outliers_classified)
```

### Aerospace & Defence

```{r industry-cleaning-10}
industry_map[["Aerospace & Defence"]] <- c(outliers[grep("aerospace",outliers)],
                                   industry_map[["Aerospace & Defence"]])

industry_map[["Aerospace & Defence"]] <- c(outliers[grep("defense",outliers)],
                                   industry_map[["Aerospace & Defence"]])

industry_map[["Aerospace & Defence"]] <- c(outliers[grep("defence",outliers)],
                                   industry_map[["Aerospace & Defence"]])

industry_map[["Aerospace & Defence"]] <- c(outliers[grep("military",outliers)],
                                   industry_map[["Aerospace & Defence"]])

industry_map[["Aerospace & Defence"]] <- c(outliers[grep("aviation",outliers)],
                                   industry_map[["Aerospace & Defence"]])



outliers_classified <-c(industry_map[["Aerospace & Defence"]],
                        outliers_classified)
```

### Library Publishing

```{r industry-cleaning-11}
industry_map[["Library & Publishing"]] <- c(outliers[grep("library",outliers)],
                                   industry_map[["Library & Publishing"]])

industry_map[["Library & Publishing"]] <- c(outliers[grep("libra",outliers)],
                                   industry_map[["Library & Publishing"]])

industry_map[["Library & Publishing"]] <- c(outliers[grep("publishing",outliers)],
                                   industry_map[["Library & Publishing"]])

industry_map[["Library & Publishing"]] <- c(outliers[grep("archiv",outliers)],
                                   industry_map[["Library & Publishing"]])




outliers_classified <-c(industry_map[["Library & Publishing"]],
                        outliers_classified)
```

### Animal Care

```{r industry-cleaning-12}
industry_map[["Animal Care"]] <- c(outliers[grep("zoo",outliers)],
                                   industry_map[["Animal Care"]])

industry_map[["Animal Care"]] <- c(outliers[grep("veterinary",outliers)],
                                   industry_map[["Animal Care"]])

industry_map[["Animal Care"]] <- c(outliers[grep("veterinarian",outliers)],
                                   industry_map[["Animal Care"]])

industry_map[["Animal Care"]] <- c(outliers[grep("animal",outliers)],
                                   industry_map[["Animal Care"]])

industry_map[["Animal Care"]] <- c(outliers[grep("pet",outliers)],
                                   industry_map[["Animal Care"]])

outliers_classified <-c(industry_map[["Animal Care"]],
                        outliers_classified)

industry_map[["Animal Care"]]
```

### Food and Bevarage

```{r industry-cleaning-13}
industry_map[["Food & Bevarage"]] <- c(outliers[grep("wine",outliers)],
                                   industry_map[["Food & Bevarage"]])

industry_map[["Food & Bevarage"]] <- c(outliers[grep("bevarage",outliers)],
                                   industry_map[["Food & Bevarage"]])

industry_map[["Food & Bevarage"]] <- c(outliers[grep("beer",outliers)],
                                   industry_map[["Food & Bevarage"]])

industry_map[["Food & Bevarage"]] <- c(outliers[grep("spirit",outliers)],
                                   industry_map[["Food & Bevarage"]])


industry_map[["Food & Bevarage"]] <- c(outliers[grep("beverage",outliers)],
                                   industry_map[["Food & Bevarage"]])

industry_map[["Food & Bevarage"]] <- c(outliers[grep("food",outliers)],
                                   industry_map[["Food & Bevarage"]])

outliers_classified <-c(industry_map[["Food & Bevarage"]],
                        outliers_classified)
```

### Hospitality

```{r industry-cleaning-14}
industry_map[["Hospitality & Events"]] <- c(outliers[grep("restaurant",outliers)],
                                   industry_map[["Hospitality & Events"]])

industry_map[["Hospitality & Events"]] <- c(outliers[grep("food service",outliers)],
                                   industry_map[["Hospitality & Events"]])

outliers_classified <-c(industry_map[["Hospitality & Events"]],
                        outliers_classified)
```

### Business or Consulting

```{r industry-cleaning-15}
industry_map[["Business or Consulting"]] <- c(outliers[grep("consulting",outliers)],
                                   industry_map[["Business or Consulting"]])

industry_map[["Business or Consulting"]] <- c(outliers[grep("environmental",outliers)],
                                   industry_map[["Business or Consulting"]])

industry_map[["Business or Consulting"]] <- c(outliers[grep("consult",outliers)],
                                   industry_map[["Business or Consulting"]])

industry_map[["Business or Consulting"]] <- c(outliers[grep("professional services",outliers)],
                                   industry_map[["Business or Consulting"]])

outliers_classified <-c(industry_map[["Business or Consulting"]],
                        outliers_classified)
```

### Automotive

```{r industry-cleaning-16}
industry_map[["Automotive"]] <- c(outliers[grep("auto",outliers)],
                                   industry_map[["Automotive"]])

outliers_classified <-c(industry_map[["Automotive"]],
                        outliers_classified)

```

### Human Resources

```{r industry-cleaning-17}

industry_map[["Recruitment or HR"]] <- c(outliers[grep("workforce",outliers)],
                                   industry_map[["Recruitment or HR"]])

industry_map[["Recruitment or HR"]] <- c(outliers[grep("staffing",outliers)],
                                   industry_map[["Recruitment or HR"]])

industry_map[["Recruitment or HR"]] <- c(outliers[grep("human",outliers)],
                                   industry_map[["Recruitment or HR"]])

outliers_classified <-c(industry_map[["Recruitment or HR"]],
                        outliers_classified)



```

### Non Profit

```{r}

industry_map[["Nonprofits"]] <- c(outliers[grep("non profit",outliers)],
                                   industry_map[["Nonprofits"]])

industry_map[["Nonprofits"]] <- c(outliers[grep("non-profit",outliers)],
                                   industry_map[["Nonprofits"]])

industry_map[["Nonprofits"]] <- c(outliers[grep("nonprofit",outliers)],
                                   industry_map[["Nonprofits"]])

outliers_classified <-c(industry_map[["Nonprofits"]],
                        outliers_classified)


```

### Overview

```{r industry-cleaning-last}

values(industry_map)

# check outliers reamining

outliers_left <- outliers_table%>%
  filter(!industry %in% outliers_classified)%>%
  group_by(industry)%>%
  summarise(total = n())
outliers_left

```

The remaining data is too fragmented to be worth further cleaning.

```{r}


test <- ask_a_manager_2021_cleaned%>%
  mutate(industry_cleaned = case_when(industry %in% standard_industry ~ industry))%>%
  mutate(industry_lower = tolower(industry))

del("NA", industry_map)
for(i in standard_industry)
{
  test<-test%>%
    mutate(industry_cleaned = case_when(industry_lower %in% values(industry_map, keys = i) ~ i,
                                        TRUE ~ industry_cleaned))
}

ask_a_manager_2021_cleaned <- test

```

**Adding ISCO classification to the dataset**

```{r industry-cleaning-isco}
occupation_classification <- labourR::classify_occupation(corpus = ask_a_manager_2021_cleaned, 
                                          isco_level = 2, 
                                          lang = "en",
                                          num_leaves = 10,
                                          text_col = "industry",
                                          id = "timestamp")%>%
   mutate(timestamp = ymd_hms(timestamp))

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(timestamp = ymd_hms(timestamp))

ask_a_manager_2021_cleaned <- left_join(ask_a_manager_2021_cleaned,
           occupation_classification,
           by = "timestamp")%>%
   clean_names()

labR_classifications <- unique(occupation_classification$preferredLabel)
labR_classifications

```

##  {.unnumbered}

## Save cleaned Data

```{r}

write_csv(ask_a_manager_2021_cleaned, here::here("data","ask_manager_2021_cleaned.csv"))

```

```{r}
#optionally load cleaned dataset from here

ask_a_manager_2021_cleaned <- read_csv(here::here("data","ask_manager_2021_cleaned.csv"))

```


# Analyses by Race 

## Multiple Races

By looking at the data it can be seen the quite a few respondents have filled out multiple options. Let s visualise how many exactly.

### Number of responses with each number of Races

```{r race-multiple-resp}


n_race_responses <- ask_a_manager_2021_cleaned%>%
  mutate(race = str_split(race,pattern = ","))%>%
  rowwise()%>%
  mutate(n_race = length(race))

n_race_sumary <- n_race_responses%>%
  group_by(n_race)%>%
  summarise(n = n())%>%
  mutate(prct = n/sum(n))

n_race_responses <- left_join(n_race_responses, n_race_sumary, by = "n_race")


ggplot(n_race_responses, 
       aes(n_race))+
  geom_bar(alpha = 0.8)+
  scale_y_log10()+
  theme_bw()+
  labs(title = "Number of Races survey respondents Identified with",
       x = "Number of Races",
       y = "Count (y axis scaled to log10)")+
  scale_x_continuous(breaks = pretty_breaks(6))+
  geom_text(aes(label = formatC(..count.., format = "f", big.mark = ",", digits = 0)), 
            stat = "count",  
            vjust = -0.4)

```

```{r}

n_race_sumary <- n_race_sumary %>%
  mutate(prct = round(prct*100, 2),
         n = formatC(n, format = "f", big.mark = ",", digits = 0))
colnames(n_race_sumary) <- c("Number of Races Respondant Identifies with",
             "Number of Respondants",
            "% of Of total respodants")
n_race_sumary
    
```
### Multiple Race by Gender and Age

Distribution of men and women who identify as more than one Race

```{r race-gender-age}

m_race_gender_summary <- n_race_responses%>%
  mutate(gender = factor(gender,
         levels = c("Man","Woman","Non-binary","Other or prefer not to answer", "NA")))%>%
  filter(n_race > 1, !is.na(gender))%>%
  group_by(gender, n_race, how_old_are_you)%>%
  summarise(number = n())%>%
  mutate(prct = number/sum(number))

ggplot(m_race_gender_summary, aes(y = number, x = reorder(n_race, number)))+
  geom_col()+
  facet_grid(gender~how_old_are_you)+
  coord_flip()+
  theme_bw()+
  labs(
    title = "Number of Race's a person identifies with by Age and Gender",
    y = "Number of Race options ticked by Respondant",
    x = "Number of Respondants"
  )

```

If we analyse the respondents that selected more then 1 race that they identify with we can see from the graph that the most prominent age groups are 25-34 and and 35-44 which would mean that Millenials are the most likely identify with multiple race's. And within the Millennial group it seems like women are more likely to do that then men. This shall be evaluated by a hypothesis testing. 

H0 = Millennial women are  equally likely to identify with multiple races as millennial men.
H1 = Millennial women are not equally likely to identify with multiple races as millennial men.

```{r millenial-race-test}

n_race_responses <- n_race_responses%>%
  mutate(multiple_race = case_when(n_race > 1 ~ 1,
                                   n_race == 1 ~0))

mill_men <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44") & n_race_responses$gender == "Man",
                   select = c(multiple_race))

mill_men

mill_women <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44") & n_race_responses$gender == "Woman",
                   select = c(multiple_race))

mill_women

t.test(mill_men, mill_women)

```

H1 can be rejected as the t-value is more then 2. 

Now lets test for the chance whether the being a millennial truly increases the likelihood of identifying with multiple races.

H0 = The proportion of millennials identifying with multiple races is the same as the proportion of other age groups that identify with multiple races. 

H1 = The proportion of millennials identifying with multiple races is not the same as the proportion of other age groups that identify with multiple races. 
```{r multiple-race-age}

millennial <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44"),
                   select = c(multiple_race))

non_millenial <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you != "25-34" & n_race_responses$how_old_are_you != "35-44"),
                   select = c(multiple_race))

t.test(millennial, non_millenial)



```
The H0 hypothesis can be rejected as t value is above 2. Which means that it can be said with 95% confidence that there is a difference between the proportion of millennials that identify with multiple races and all other age groups. 


### Multiple Race by Country

```{r multiple-race-country}
m_race_country_summary <- n_race_responses%>%
  mutate(gender = factor(gender,
         levels = c("Man","Woman","Non-binary","Other or prefer not to answer", "NA")))%>%
  filter(!is.na(country))%>%
  group_by(country)%>%
  summarise(multiple_race, pop = n())%>%
  ungroup()%>%
  group_by(country, multiple_race)%>%
  summarise(pop, 
            mult_race_num = n())%>%
  filter(multiple_race ==1)%>%
  mutate(prop_resp  = multiple_race/pop)%>% # get the percentage of respondants that identify with multiple races
  group_by(country)%>%
  summarise(pop = max(pop),
            mult_race_num = max(mult_race_num), 
            prop_resp = round(max(prop_resp)*100, 5))%>%
  arrange(desc(prop_resp))

colnames(m_race_country_summary) <- c("Country","Num. Responses", "Num. Responses with Num. Race >1","% of response with num_race > 1")

m_race_country_summary
```


Some Countries have a very small representation within the dataset and the respondents from there have filled out multiple races. These countries will be excluded from the race statistics going forward where only entries with a single race will be used as the multi race selections are a relatively low proportion of the respondents. 


## Single Race Responses


```{r single-race}
single_race_data <- n_race_responses%>%
  filter(multiple_race == 0)%>% # only use responses that only put down one race
  mutate(race = as.character(race[1]))%>%
  filter(!is.na(race))




single_race_data <-single_race_data%>%
  group_by(country)%>%
  mutate(num_resp_country = n())%>%
  ungroup()%>%
  group_by(race)%>%
  mutate(num_resp_race = n())%>%
  ungroup()

```

### Race Distribtion of the Dataset

```{r}

ggplot(single_race_data, aes(reorder(race, num_resp_race)))+
  geom_bar()+
  coord_flip()+
  theme_bw()+
  labs(title = "Race distribution by single race",
       y = "number of responses",
       x = "race")

```



### Race distribution from countries with more then 50 responses

```{r race-distribution}

country_race <- single_race_data%>%
  filter(num_resp_country > 50, !is.na(race))%>%
  rowwise()%>%
  mutate(race = as.character(race[1]))%>%
  group_by(country, race)%>%
  summarise(num_resp_country, race_count = n())%>%
  mutate(race_prc = race_count/num_resp_country)%>%
  summarise(num_resp_country = max(num_resp_country),
            race_count = max(race_count),
            race_prc = max(race_prc))%>%
  mutate(race_prc = round(race_prc*100,2))

ggplot(country_race,aes(y = reorder(race, race_prc), x = race_prc))+
  geom_col( aes(fill = race))+
  facet_wrap(~country)+
  theme(axis.title.y = element_blank(),
        plot.title = element_text())+
  labs(title = "Population Distribution in Countries with more then 50 respondants",
       x = "% of Respondents",
       fill  = "Race Classification")
```
### Race by Industry

```{r}

industry_race <- single_race_data%>%
  filter(!is.na(industry_cleaned), num_resp_country > 50, !is.na(country), !is.na(race))%>%
  group_by(industry_cleaned, race)%>%
  summarise(race_count = n())%>%
  mutate(race_prc = race_count/sum(race_count))%>%
  mutate(race_prc = round(race_prc*100,2))%>%
  ungroup()%>%
  group_by(industry_cleaned)%>%
  mutate(industry_total = sum(race_count))
  

ggplot(industry_race, aes(y = reorder(industry_cleaned, race_count), x = race_count, fill = race ))+
  geom_col()+
  labs(title = "Race distribution within Industries",
       x = "Number of Respondants",
       y = "Industry Classification")+
  theme_bw()
  
```

```{r}
industry_race_top5 <- industry_race%>%
  pivot_wider(id_cols = 1, names_from = race, values_from = 3)%>%
  replace(is.na(.), 0)%>%
  mutate(industry_total = rowSums(across(where(is.numeric))))%>%
  arrange(desc(industry_total))%>%
  head(5)%>%
  pivot_longer(cols = 2:7, names_to = "race")%>%
  group_by(industry_cleaned)%>%
  mutate(prc = round(value/sum(value)*100, 2))
  

  
ggplot(industry_race_top5, aes(y = reorder(industry_cleaned, value), x = value, fill = race ))+
  geom_col()+
  labs(title = "Race distribution within top 5 Industries",
       x = "Number of Respondants",
       y = "Industry Classification")+
  theme_bw()
  # geom_text(aes(label = sprintf("%.2f%%",prc)), position = position_stack(vjust = 0.5))  geom_text(aes(l
```

```{r}

mosaic::favstats(ask_a_manager_2021_cleaned$salary_usd)

ask_a_manager_2021_cleaned%>%
  filter(salary_usd > 10000000)

test <- ask_a_manager_2021_cleaned%>%
  group_by(country)%>%
  mutate(num_responses_country = n())%>%
  ungroup()%>%
  filter(num_responses_country > 50)

ggplot(test,aes(x = as.numeric(salary_usd)))+
  geom_density()+
  scale_x_continuous(labels = function(salary_usd) sprintf("%.f", salary_usd/1000), limits = c(0, 1000000))+
  facet_wrap(~country)+
  theme_bw()+
  labs(title = "Density Distribution of Salaries by Country",
       x = "Salary in Thousands (USD)",
       y = "density")


ggplot(test, aes(salary_usd, country))+
  geom_boxplot()+
  scale_x_log10()
```


#Country 

1.) Mean salary for US, UK, Canada, Australia, Germany, 
```{r}

library(infer)
#we want to work on the top 5 countries with the most data points..

country_codes <- c("USA", "GBR", "AUS", "CAN", "DEU")


```


#What is the most popular industry among the five countries we selected?
```{r}
#Industry exploration: gives salary by the selected countries and all industry
salary_exploration <- ask_a_manager_2021_cleaned %>% 
  filter(!is.na(salary_usd)) %>%    
  filter(country_code %in% country_codes) %>% 
  select(country, country_code, salary_usd, industry) %>% 
  group_by(country_code)

salary_exploration 

#Choosing the most popular industries in the survey for the designated countries
industry_count <- salary_exploration %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))
industry_count
```

Overall Computing or Tech is the most popular sector among the 5 chosen countries, followed by Education, Nonprofits...


We would like to see the popularity of the Computing or Tech industry in each country:

```{r}
#for us
popularity_usa <- salary_exploration %>% 
  filter(country_code == "USA") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(!is.na(industry)) %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))

popularity_usa
```

In the US, the most popular industry is Computing or Tech like the overall population. Since US has the most datapoints, it might have affected the distribution of the popularity of tech overall in global data. 

```{r}
popularity_uk <- salary_exploration %>% 
  filter(country_code == "GBR") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(!is.na(industry)) %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))

popularity_uk
```

In the UK, Computing or Tech is the most popular sector among the survey takers as well. And Accounting, Banking & Finance follows. 


```{r}

popularity_uk <- salary_exploration %>% 
  filter(country_code == "GBR") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(!is.na(industry)) %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))

popularity_uk
```




```{r}
popularity_deu <- salary_exploration %>% 
  filter(country_code == "DEU") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(!is.na(industry)) %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))

popularity_deu
```
In Germany, the most popular sector is Computing or Tech as well. 



```{r}
#for australia
popularity_aus <- salary_exploration %>% 
  filter(country_code == "AUS") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(!is.na(industry)) %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))
popularity_aus
```
Computing or Tech is the most popular sector in Australia as well!


```{r}
popularity_can <- salary_exploration %>% 
  filter(country_code == "CAN") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(!is.na(industry)) %>% 
  group_by(industry) %>% 
  count() %>% 
  arrange(desc(n))
popularity_can
```

Tech is the most popular sector in Canada too. 


In every single country on our country list, tech is the most popular industry. Now, we would like to see the mean and median tech salary by each country. That's why, it is reasonable to focus on the Tech sector.


Boxplot of Computing or Tech salaries across USA, Australia, Germany, UK, Canada
```{r}
tech_salary_boxplot_data <- salary_exploration %>%
  filter(industry =="Computing or Tech")

tech_salary_boxplot <- ggplot(data = tech_salary_boxplot_data, aes(x = salary_usd, y=fct_reorder(country, salary_usd))) +
  geom_boxplot() +
  labs( title= " Tech salaries across USA, Australia, Germany, UK, Canada",
        x="Salary (USD)",
        y="Countries")

tech_salary_boxplot
```
According to the box plot, USA has the highest mean Computing and Tech Salary. USA also has high variability, since it is known as the tech hub of the world which leads to some salaries being extremely high. 

```{r}

mean_median_tech_salary_by_country <- ask_a_manager_2021_cleaned %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(country_code  %in% country_codes ) %>% 
  filter(industry == "Computing or Tech") %>% 
  group_by(country_code) %>% 
  summarise(mean_tech_salary = mean(salary_usd),
            median_tech_salary = median(salary_usd)) %>% 
  arrange(desc(mean_tech_salary))


mean_median_tech_salary_by_country


```
USA has more mean and median tech salary, followed by Australia and Germany and UK.

```{r}
set.seed(123)


#####CI for USA Mean Salary

#confidence interval bootstrap
boot_dist_usa <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "USA") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(industry == "Computing or Tech") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")
boot_dist_usa



percentile_ci_usa2 <- get_ci(boot_dist_usa , level = 0.95, type ="percentile") 
#for visualisation


#CI and mean table
percentile_ci_usa <- get_ci(boot_dist_usa , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "USA",
         mean = mean_median_tech_salary_by_country[[1,2]]) %>% 
  relocate(country_code)



#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_usa ) +
  shade_ci(endpoints = percentile_ci_usa2, fill="khaki")
```

```{r}
#####CI for Germany Salary

#confidence interval bootstrap
boot_dist_deu <-ask_a_manager_2021_cleaned%>% 
  filter(country_code == "DEU") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(industry == "Computing or Tech") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")

boot_dist_deu

#Creating the CI table with the country code
percentile_ci_deu <- get_ci(boot_dist_deu , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "DEU",
         mean = mean_median_tech_salary_by_country[[3,2]]) %>% 
  relocate(country_code)
percentile_ci_deu


percentile_ci_deu2 <- get_ci(boot_dist_deu , level = 0.95, type ="percentile") #for visualisation

#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_deu) +
  shade_ci(endpoints = percentile_ci_deu2, fill="khaki")

```


```{r}
######CI for Australia Salary

#confidence interval bootstrap
boot_dist_aus <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "AUS") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(industry == "Computing or Tech") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")


#creating the CI table with country code
percentile_ci_aus <- get_ci(boot_dist_aus , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "AUS",
         mean = mean_salary_by_country[[2,2]]) %>% 
  relocate(country_code) 

percentile_ci_aus2 <- get_ci(boot_dist_aus , level = 0.95, type ="percentile") #for visualisation

#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_aus) +
  shade_ci(endpoints = percentile_ci_aus2, fill="khaki")


```



```{r}
####CI for UK
  
  boot_dist_gbr <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "GBR") %>% 
  filter(!is.na(salary_usd)) %>% 
  filter(industry == "Computing or Tech") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")
  
  
#creating the CI table with country code
percentile_ci_gbr <- get_ci(boot_dist_gbr , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "GBR",
         mean = mean( mean_salary_by_country[[4,2]])) %>% 
  relocate(country_code)

 percentile_ci_gbr2 <- get_ci(boot_dist_gbr , level = 0.95, type ="percentile") #for visualisation
 
#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_gbr) +
  shade_ci(endpoints = percentile_ci_gbr2, fill="khaki")

  
```

```{r}

#####CI for Canada Salary
  
  #confidence interval bootstrap
boot_dist_can <- ask_a_manager_2021_cleaned%>% 
  filter(country_code == "CAN") %>%   
  filter(!is.na(salary_usd)) %>% 
  filter(industry == "Computing or Tech") %>% 
  specify(response = salary_usd) %>%
  # Generate bootstrap samples
  generate(reps = 1000, type = "bootstrap") %>%
  # Calculate mean of each bootstrap sample
  calculate(stat = "mean")


#creating the CI table with country code
percentile_ci_can <- get_ci(boot_dist_can , level = 0.95, type ="percentile") %>% 
  mutate(country_code = "CAN",
         mean = mean_salary_by_country[[5,2]]) %>% 
  relocate(country_code)

percentile_ci_can2 <- get_ci(boot_dist_can , level = 0.95, type ="percentile") #for visualisation

#visualisation of the resulting bootstrap distribution and the CIs
  visualize(boot_dist_can) +
  shade_ci(endpoints = percentile_ci_can2, fill="khaki")
  
  
#Merged table of CIs and means..
merged_table <- rbind(percentile_ci_usa, percentile_ci_deu) 
merged_table <- rbind(merged_table, percentile_ci_aus) 
merged_table <- rbind(merged_table, percentile_ci_gbr) 
merged_table <- rbind(merged_table, percentile_ci_can)
merged_table
```


```{r}

#Graph of CIs:
 graph <- ggplot(merged_table, aes(colour = country_code)) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci, y= country_code), width = 0.1, size = 1.5)  +
  geom_point(aes(x=mean, y=country_code), size = 3 ) +
  labs(title="Confidence Intervals of Mean Salary by Country in Computing and Tech Industry",
       subtitle="95% confidence intervals",
       x="Mean Salary (USD)",
       y =" ") +
  theme_bw() +
    geom_text(aes(label = round(mean,0), round(mean,0), y=country_code), size = 3, color="black", hjust = 0.5, vjust = 2, nudge_x = 0.00, nudge_y = 0.00)

graph

```


We created this graph in order to have an overall understanding of the selected countries' mean salaries in tech and the confidence intervals of their mean. Because USA has more data points, its confidence interval is narrower. 


According to the graph, USA and Germany are leading the tech industry in the world in terms of salaries. Is there an actual difference in the mean salaries for tech industry in USA and Germany? In order to proceed, we will conduct hypothesis testing. 

H0: There's no difference between the salaries of US and Germany in the Computing and Tech industry.
H1: There's a difference between the salaries of US and Germany in the Computing and Tech industry.


Use the infer package for hypothesis testing: 

```{r}

tech_usa_aus <- salary_exploration %>% 
  filter(country_code %in% c("AUS" , "USA")) %>%   
  filter(!is.na(salary_usd)) 


 null_dist <- tech_usa_aus %>%
  # specify variables
  specify(salary_usd  ~  country_code)  %>%
  
  # assume independence, i.e, there is no difference
  hypothesize(null = "independence") %>%
  
  # generate 1000 reps, of type "permute"
  generate(reps = 1000, type = "permute") %>%
  
  # calculate statistic of difference, namely "diff in means"
  calculate(stat = "diff in means", order = c("AUS", "USA"))


ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram()

obs_diff <- tech_usa_aus %>%
  specify(salary_usd  ~  country_code) %>%
  calculate(stat = "diff in means", order = c("AUS", "USA"))


null_dist %>% visualize() +
  shade_p_value(obs_stat = obs_diff, direction = "two-sided")

```

According to the hypothesis testing, we can reject the null hypothesis that there is a difference between the mean salaries for tech employees in USA and Australia 



So, since USA dominates the Tech industry, we would like to analyse the factors that affect the tech salary like income and years of of experience at work.  

Conclusion: US is the place to be for Tech! 

#Factors that affet tech salaries in the US 


```{r}



```


Education High Salaries
Experience High Salaries

What is more important? 




#Gender

##Summary Statistics
```{r}
#Table giving counts for each gender category dropping those who left the question blank
ask_a_manager_2021_cleaned %>% 
  drop_na(gender) %>%
  count(gender, sort=T, .drop=T) 

#Summary Statistics of Gender and Salary in USD
ask_a_manager_2021_cleaned %>% 
  group_by(gender) %>%
  drop_na(gender) %>%
  summarise(MeanSalary=mean(salary_usd, na.rm=TRUE), 
            MedianSalary=median(salary_usd, na.rm=T), 
            sdsalary= sd(salary_usd, na.rm=TRUE), 
            q1salary=quantile(salary_usd, prob=.25, na.rm=TRUE), 
            q3salary=quantile(salary_usd, prob=.75, na.rm=TRUE),
            minsalary=min(salary_usd, na.rm=T),
            maxsalary=max(salary_usd, na.rm=T)) 

ask_a_manager_2021_cleaned_gender <- ask_a_manager_2021_cleaned %>%
  drop_na(gender)

write.csv(ask_a_manager_2021_cleaned_gender, "test.csv")

```

##Plots with experience and salary
```{r}
ggplot(ask_a_manager_2021_cleaned_gender, aes(x=gender, y=salary_usd))+
  geom_boxplot()+
  scale_y_log10()+
  labs(title= "Salary in USD by Gender", x="Gender", y="Salary in USD")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 0.8))+
  NULL
```

```{r}
ggplot(ask_a_manager_2021_cleaned_gender, aes(x=overall_years_of_professional_experience, y=salary_usd,color=gender))+
  geom_boxplot()+
  scale_y_log10()+
  facet_wrap(~gender)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 0.8))+
  labs(title= "Salary in USD by Gender and Total Years of Experience", x="Total Years of Experience", y="Salary in USD")+
  NULL
  
ggplot(ask_a_manager_2021_cleaned_gender, aes(x=years_of_experience_in_field, y=salary_usd,color=gender))+
  geom_boxplot()+
  scale_y_log10()+
  facet_wrap(~gender)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 0.8))+
  labs(title= "Salary in USD by Gender and Years of Experience in Field", x="Years of Experience in   Field", y="Salary in USD")+
  NULL
```

##Plots with education and salary
```{r}
ggplot(ask_a_manager_2021_cleaned_gender, aes(x=highest_level_of_education_completed, y=salary_usd, color=gender))+
  geom_boxplot()+
  scale_y_log10()+
  facet_wrap(~gender)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 20, hjust = 0.8))+
  labs(title= "Salary in USD by Gender and Education Level", x="Education Level", y="Salary in USD")+
  NULL
```

#Linear Model
```{r}

names(ask_a_manager_2021_cleaned_gender)
ask_lm <- lm(salary_usd ~ country ,
             data=ask_a_manager_2021_cleaned_gender, )

ask_lm %>% 
  get_regression_table()

ask_lm %>% 
  get_regression_summaries()

ask_a_manager_2021_cleaned_gender_country <- ask_a_manager_2021_cleaned_gender %>% 
  filter(country == "United States")

ask_lm <- lm(salary_usd ~ gender +
               race + 
               overall_years_of_professional_experience + 
               how_old_are_you + industry + 
               highest_level_of_education_completed,
               data=ask_a_manager_2021_cleaned_gender_country )

ask_lm %>% 
  get_regression_table()

ask_lm %>% 
  get_regression_summaries()

#Summary Stats of Salary by Gender in the USA
ask_a_manager_2021_cleaned_gender_country %>% 
  group_by(gender) %>%
  drop_na(gender) %>%
  summarise(MeanSalary=mean(salary_usd, na.rm=TRUE), 
            MedianSalary=median(salary_usd, na.rm=T), 
            sdsalary= sd(salary_usd, na.rm=TRUE), 
            q1salary=quantile(salary_usd, prob=.25, na.rm=TRUE), 
            q3salary=quantile(salary_usd, prob=.75, na.rm=TRUE),
            minsalary=min(salary_usd, na.rm=T),
            maxsalary=max(salary_usd, na.rm=T)) 

```

```{r}
#loading the libraries
library(usmap)
library(ggplot2)

#cleaning the dataset to include data only from the US and cleaning the names in the State column
ask_a_manager_states_clean <- ask_a_manager_2021_cleaned %>% 
  filter(country == "United States") %>% 
  rowwise() %>% 
  mutate(state = str_split(state, ",")) %>% 
  mutate(state = as.character(state[1]))

#creating a new dataframe with the mean salaries for each state
usmap_df <- ask_a_manager_states_clean %>% 
  group_by(state) %>% 
  summarise(median_salary = median(salary_usd, na.rm = TRUE)) 

#plotting the data with a color code
plot_usmap(regions = "state", data = usmap_df, values = "median_salary") + 
  labs(title = "Median Salary by State in the United States of America",
       subtitle = "Ask a Manager Survey 2021") + 
  scale_fill_continuous(low = "white", 
                        high = "red", 
                        name = "Salary in US $", 
                        label = scales::comma)+
  theme(panel.background=element_blank(), legend.position = "right")

```


```{r}

ask_a_manager_2021_lm <- ask_a_manager_2021_cleaned %>%
  filter(country == "United States") %>%
  filter(industry == "Computing or Tech") 

ask_lm <- lm(salary_usd ~ highest_level_of_education_completed*years_of_experience_in_field ,
                          data=ask_a_manager_2021_lm )

ask_lm %>% 
  get_regression_table()

ask_lm %>% 
  get_regression_summaries()

```

