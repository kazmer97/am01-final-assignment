---
author: "Study Group 11: Nereid Kwok, Nisa Ozer, Lauren Wade, Thomas Giannetti-Fakhouri, Kazmer Nagy-Betegh, Chandrime Tolia"

title: "Final Assignment"

date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
    df_print: paged
---

```{r , echo=FALSE}


knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)


# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r initialise-libraries, echo=FALSE}

library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(lubridate)
library(labourR)
library(magrittr)
library(gapminder)
library(quantmod)
library(stringr)
library(stringdist)
library(hash)
library(scales)
library(gt)
```



# Data Import

```{r import-ask-manager}

# Google Sheets permissions did not work with my google account

# use googlesheets4 to get data
url <- "https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792"
googlesheets4::gs4_auth() # google sheets authorisation

# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- googlesheets4::read_sheet(url) %>%
  janitor::clean_names()

# if googlesheets is now working, read local copy
# ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))%>%
  # janitor::clean_names()
  
```

# Intitial Data Exploration and Cleaning

```{r data-explore}

skimr::skim(ask_a_manager_2021)
```


## Clean Country Names

```{r country-code-cleaning}

# unique(ask_a_manager_2021$country) # checking the list of unique country codes reveals that country names are inconsistent across the data

ask_a_manager_2021_cleaned <- ask_a_manager_2021%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021$country, 
                                       origin = 'country.name', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(
    country = countrycode::countrycode(sourcevar = ask_a_manager_2021_cleaned$country, 
                                       origin = 'unicode.symbol', 
                                       destination = 'country.name', 
                                       warn = TRUE, 
                                       nomatch = NULL)
    )



country_list <- unique(countryname_dict$country.name.en)

typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
  
unique(typos$country) #identifying the the typos and mismatches that the country code library couldn't deal with

typo_map <- hash() #create a map for the correct version of the typos


typo_map[["United Kingdom"]] <- list("Scotland",
                                     "England",
                                     "Northern Ireland",
                                     "England/UK",
                                     "England, UK",
                                     "United Kindom",
                                     "UK (Northern Ireland)",                                                                                              "UK for U.S. company",
                                     "England, Gb",
                                     "Englang",
                                     "England, Gb",
                                     "U.K. (northern England)",
                                     "Unites kingdo",
                                     "Unites kingdom",
                                     "UK (England)",
                                     "england",
                                     "Jersey", 
                                     "Channel islands",
                                     "UK, remote",
                                     "Scotland, UK",
                                     "England, UK.",
                                     "Jersey, Channel islands",
                                     "Wales, UK",
                                     "Wales (UK)",
                                     "UK, but for globally fully remote company",
                                     "Wales"
                                     )
typo_map[["United States"]] <- list("United State",
  "ISA",
 "America",
"United State of America",
"United Stated",
"USA-- Virgin Islands",
"United Statws" ,
"Unites States" ,
"U. S.",
"United Sates",
"Uniited States",
"Worldwide (based in US but short term trips aroudn the world)",
"United Sates of America",
"United States (I work from home and my clients are all over the US/Canada/PR",
"Unted States",
"United Statesp",
"United Stattes",
"United Statea",
"United Statees",
"Uniyed states",
"Uniyes States",
"United Status",
"Uniteed States",
"United Stares",
"Unites states",
"Unite States",
"The US",
"United statew",
"United Statues",
"Untied States",
"Unitied States",
"United Sttes",
"united stated",
"Uniter Statez",
"U. S" ,
"United Stateds",
"Usat",
"Unitef Stated",
"USaa",
"america",
"United States- Puerto Rico",
"California",
"Virginia",
"Hartford",
"San Francisco",
"USD",
"United Statss",
"I work for a UAE-based organization, though I am personally in the US.",
"United  States",
"U.A.",
"UXZ",
"USS",
"IS",
"USAB",
"UA",
"I.S",
"I.S.",
"United y"
)

typo_map[["Canada"]] <- list(
  "Canadw",
"Can",
"Canda",
"Canada and USA",
"Csnada",
"Canad"
)

typo_map[["NA"]] <- list(
  "Contracts",
"We don't get raises, we get quarterly bonuses, but they periodically asses income in the area you work, so I got a raise because a 3rd party assessment showed I was paid too little for the area we were located",
"Global" ,
"Currently finance",
"UXZ",
"$2,175.84/year is deducted for benefits",
"Remote",
"bonus based on meeting yearly goals set w/ my supervisor",
"I earn commission on sales. If I meet quota, I'm guaranteed another 16k min. Last year i earned an additional 27k. It's not uncommon for people in my space to earn 100k+ after commission.",
"I was brought in on this salary to help with the EHR and very quickly was promoted to current position but compensation was not altered.",
"n/a (remote from wherever I want)",
"Africa",
"europe",
"na",
"Policy",
"NA",
"International",
"NZ",
"Y"
)

typo_map[["Spain"]] <- list("Catalonia")

typo_map[["Australia"]] <- list("Australi")

typo_map[["Denmark"]] <- list("Danmark")

typo_map[["Netherlands"]] <- list("NL",
"Nederland")

typo_map[["Panama"]] <- list("Panamá")

typo_map[["Brazil"]] <- list("Brasil")

typo_map[["Argentina"]] <- list("ARGENTINA BUT MY ORG IS IN THAILAND")

typo_map[["Mexico"]] <- list("México")

for (c in keys(typo_map))
{
  ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country = case_when(country %in% values(typo_map, keys = c) ~c,
                              !country %in% values(typo_map, keys = c) ~ country))
}

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned%>%
  mutate(country_code = countrycode::countrycode(sourcevar =  ask_a_manager_2021_cleaned$country,
                                                 origin = 'country.name',
                                                 destination = 'iso3c',
                                                 nomatch = NA,
                                                 warn = TRUE))

```


```{r}
typos <- ask_a_manager_2021_cleaned%>%
  filter(!country %in% unique(countryname_dict$country.name.en))
unique(typos$country)

unique(ask_a_manager_2021_cleaned$country)
```

## Currency 

```{r }

ask_a_manager_2021_cleaned$currency <- substr(ask_a_manager_2021_cleaned$currency, 0, 3)

from <- ask_a_manager_2021_cleaned$currency
to <- c("USD")
exchange_rate <- getQuote(paste0(from, to, "=X"))
  
exchange_rate <- exchange_rate[-c(8),] 

exchange_rate <- exchange_rate %>% 
  mutate(currency = c("USD", "GBP", "CAD", "EUR", "AUD", "CHF", "ZAR", "SEK", "HKD", "JPY")) %>% 
  select(currency, Last)%>%
  clean_names()

ask_a_manager_2021_cleaned <-
  merge(ask_a_manager_2021_cleaned, exchange_rate, by="currency", all.x = T)

ask_a_manager_2021_cleaned <- ask_a_manager_2021_cleaned %>%  
  mutate(salary_USD = annual_salary * Last)%>%
  clean_names()

```

# Analyses of Race within the Dataset

By looking at the data it can be seen the quite a few respondents have filled out multiple options. Let s visualise how many exactly.

```{r race-multiple-resp}


n_race_responses <- ask_a_manager_2021_cleaned%>%
  mutate(race = str_split(race,pattern = ","))%>%
  rowwise()%>%
  mutate(n_race = length(race))

n_race_sumary <- n_race_responses%>%
  group_by(n_race)%>%
  summarise(n = n())%>%
  mutate(prct = n/sum(n))

n_race_responses <- left_join(n_race_responses, n_race_sumary, by = "n_race")


ggplot(n_race_responses, 
       aes(n_race))+
  geom_bar(alpha = 0.8)+
  scale_y_log10()+
  theme_bw()+
  labs(title = "Number of Races survey respondents Identified with",
       x = "Number of Races",
       y = "Count (y axis scaled to log10)")+
  scale_x_continuous(breaks = pretty_breaks(6))+
  geom_text(aes(label = formatC(..count.., format = "f", big.mark = ",", digits = 0)), 
            stat = "count",  
            vjust = -0.4)




  # geom_errorbarh(aes(xmin = n_race - 0.5, 
  #                    xmax = 6.5, 
  #                    y = n,color = n_race), 
  #                hjust = -2
  #                )
  # # geom_text(aes(label = sprintf("%.2f%% of respondants", 100*prct)),
  # #           hjust = +0.3, vjust = -0.5)
  # # xlim(0, 7)
  
  
  

```

```{r}

n_race_sumary %>%
  mutate(prct = round(prct*100, 2),
         n = formatC(n, format = "f", big.mark = ",", digits = 0))%>%
  kbl(caption = "Respondants and Number of Races they identify with",
    col.names = c("Number of Races Respondant Identifies with",
             "Number of Respondants",
            "% of Of total respodants"),
    
    )%>%
  kable_styling()
```
Distribution of men and women who identify as more than one Race

```{r race-gender-age}

m_race_gender_summary <- n_race_responses%>%
  mutate(gender = factor(gender,
         levels = c("Man","Woman","Non-binary","Other or prefer not to answer", "NA")))%>%
  filter(n_race > 1, !is.na(gender))%>%
  group_by(gender, n_race, how_old_are_you)%>%
  summarise(number = n())%>%
  mutate(prct = number/sum(number))

ggplot(m_race_gender_summary, aes(y = number, x = reorder(n_race, number)))+
  geom_col()+
  facet_grid(gender~how_old_are_you)+
  coord_flip()+
  theme_bw()+
  labs(
    title = "Number of Race's a person identifies with by Age and Gender",
    y = "Number of Race options ticked by Respondant",
    x = "Number of Respondants"
  )

```

If we analyse the respondents that selected more then 1 race that they identify with we can see from the graph that the most prominent age groups are 25-34 and and 35-44 which would mean that Millenials are the most likely identify with multiple race's. And within the Millennial group it seems like women are more likely to do that then men. This shall be evaluated by a hypothesis testing. 

H0 = Millennial women are  equally likely to identify with multiple races as millennial men.
H1 = Millennial women are not equally likely to identify with multiple races as millennial men.

```{r}

n_race_responses <- n_race_responses%>%
  mutate(multiple_race = case_when(n_race > 1 ~ 1,
                                   n_race == 1 ~0))

mill_men <- subset(n_race_responses, 
                   (n_race_responses$how_old_are_you == "25-34" || n_race_responses$how_old_are_you == "35-44") & n_race_responses$gender == "Men",
                   select = c(multiple_race))

mill_men

t.test()

```



```{r}

model1 <- lm(n_race ~ gender+how_old_are_you,
             data = n_race_responses)

summary(model1)
```